# SRS Configuration File
# Complete configuration for RTMP ingestion and HLS playback

listen              1935;
max_connections     1000;
daemon              off;
srs_log_tank        console;

# HTTP API configuration
http_api {
    enabled         on;
    listen          1985;
    crossdomain     on;
}

# HTTP Server for HLS delivery
http_server {
    enabled         on;
    listen          8080;
    dir             ./objs/nginx/html;
    crossdomain     on;
}

# Statistics
stats {
    network         0;
    disk            sda sdb xvda xvdb;
}

# RTMP virtual host
vhost __defaultVhost__ {
    # HLS delivery
    hls {
        enabled         on;
        hls_path        ./objs/nginx/html;
        hls_fragment    10;
        hls_window      60;
        hls_cleanup     on;
        hls_dispose     0;
        hls_m3u8_file   [app]/[stream].m3u8;
        hls_ts_file     [app]/[stream]-[seq].ts;
    }

    # HTTP Callbacks for stream authentication
    http_hooks {
        enabled         on;
        on_publish      http://app:80/api/srs/on_publish;
        on_unpublish    http://app:80/api/srs/on_unpublish;
        on_play         http://app:80/api/srs/on_play;
        on_stop         http://app:80/api/srs/on_stop;
    }

    # DVR (Digital Video Recording) - optional
    dvr {
        enabled         off;
        dvr_path        ./objs/nginx/html/[app]/[stream].[timestamp].flv;
        dvr_plan        session;
        dvr_duration    30;
        dvr_wait_keyframe   on;
    }

    # Transcoding - optional, can be enabled for multiple quality streams
    transcode {
        enabled     off;
        ffmpeg      ./objs/ffmpeg/bin/ffmpeg;
        
        # 720p output
        engine hd {
            enabled         off;
            vcodec          libx264;
            vbitrate        1500;
            vfps            30;
            vwidth          1280;
            vheight         720;
            vthreads        2;
            vprofile        main;
            vpreset         medium;
            acodec          aac;
            abitrate        128;
            asample_rate    44100;
            achannels       2;
            output          rtmp://127.0.0.1:[port]/[app]?vhost=[vhost]/[stream]_[engine];
        }
    }

    # Forward stream to other servers (optional)
    forward {
        enabled     off;
        destination 127.0.0.1:1936;
    }
}
